#!/bin/bash -e

# docker build, tag, and push a docker image to quay.io/coreos/tectonic-console
# Will push a sha-named image at every run, will tag that image as "latest"
# if it appears to be the tip of master, will tag that image with a
# git tag if one is present.

registry=quay.io
repo=$registry/coreos/tectonic-console

if [ -v $DOCKER_USER ] || [ -v $DOCKER_PASSWORD ]; then
    echo "env variables not set: DOCKER_USER, DOCKER_PASSWORD. skipping login, assuming creds in .dockercfg"
else
    echo logging in as $DOCKER_USER
    docker login --username="$DOCKER_USER" --password="$DOCKER_PASSWORD" --email="docker.login@coreos.com" $registry
fi

git_sha=$(git rev-parse HEAD)
git_tag=$(git tag -l --points-at HEAD)

docker build -q --rm=true -t $repo:$git_sha .
docker push $repo:$git_sha

if git diff --quiet HEAD origin/master; then
   docker tag -f $repo:$git_sha $repo:latest
   docker push $repo:latest
fi

if [ ! -z ${git_tag} ]; then
    docker tag -f $repo:$git_sha $repo:$git_tag
    docker push $repo:$git_tag
fi
