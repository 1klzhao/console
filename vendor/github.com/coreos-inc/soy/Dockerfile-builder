# Used for compiling the soy and creme applications
# quay.io/coreosinc/soy-builder

FROM golang:1.5.3

MAINTAINER Derek Parker - CoreOS

ENV GO15VENDOREXPERIMENT=1

# nodejs and web build tools
RUN echo deb http://ftp.us.debian.org/debian sid main > /etc/apt/sources.list
RUN apt-get update \
    && apt-get install --no-install-recommends -y -q \
    sudo wget jq npm git autoconf automake unzip libtool \
    && rm -rf /var/lib/apt/lists/*

RUN ln -s /usr/bin/nodejs /usr/bin/node

# Download and install protobuf compiler
RUN git clone https://github.com/google/protobuf /tmp/protobuf \
    && cd /tmp/protobuf \
    && ./autogen.sh \
    && ./configure --prefix=/usr \
    && make \
    && make check \
    && make install \
    && rm -rf /tmp/protobuf

# for gogo protobuf
RUN go get -u github.com/gogo/protobuf/proto
RUN go get -u github.com/gogo/protobuf/protoc-gen-gogo
RUN go get -u github.com/gogo/protobuf/gogoproto
RUN go get -u github.com/gogo/protobuf/protoc-gen-gofast

# for test stuff
RUN go get golang.org/x/tools/cmd/cover
RUN go get golang.org/x/tools/cmd/vet
RUN go get github.com/jackc/tern
RUN go get github.com/tools/godep
RUN go get github.com/jstemmer/go-junit-report

# node specific build tools
RUN npm install -g gulp bower

ADD creme/web/package.json /opt/creme/package.json
RUN cd /opt/creme && npm install
