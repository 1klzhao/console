#!/bin/bash -e

bucket=cdn.tectonic.com/account.tectonic.com
trap "exit" INT

function upload {
  file=$1
  dest=$2
  contentType=$3

  resource="/${bucket}/$dest"
  dateValue=`date -u +"%a, %d %b %Y %H:%M:%S GMT"`
  stringToSign="PUT\n\n${contentType}\n${dateValue}\n${resource}"

  signature=`echo -en ${stringToSign} | openssl sha1 -hmac ${S3_CDN_SECRET} -binary | base64`

  curl --upload-file ${file} \
      -H "Date: ${dateValue}" \
      -H "Content-type: ${contentType}" \
      -H "Authorization: AWS ${S3_CDN_KEY}:${signature}" \
      http://s3.amazonaws.com${resource}

  echo uploaded to $resource
}

# upload js dist files into bucket root
for f in web/public/dist/*.js; do
  upload $f $(basename $f) "application/javascript"
done

## upload css dist files into bucket root
for f in web/public/dist/*.css; do
  upload $f $(basename $f) "text/css"
done

# upload entire mochi dir into /mochi
for f in $(find web/public/dist/lib/mochi -type f); do
  dest="${f/web\/public\/dist\//}"
  mime=$(file --mime-type $f | awk '{print $2}')
  filename=$(basename "$f")
  extension="${filename##*.}"
  if [ "$extension" == "svg" ]; then
    mime="image/svg+xml"
  fi
  upload $f $dest $mime
done
