apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: tectonic-console
  labels:
    app: tectonic-console
    component: ui
spec:
  replicas: 1
  template:
    metadata:
      name: tectonic-console
      labels:
        app: tectonic-console
        component: ui
    spec:
      containers:
      - name: tectonic-console
        image: quay.io/coreos/tectonic-console:{{.componentVersion}}
        imagePullPolicy: IfNotPresent
        command: ["/opt/bridge/bin/bridge"]
        ports:
        - containerPort: 80
          protocol: TCP
        env:
        - name: BRIDGE_K8S_MODE
          value: "in-cluster"
        - name: BRIDGE_K8S_AUTH
          value: "service-account"
        - name: BRIDGE_LISTEN
          value: "https://0.0.0.0:80"
        - name: BRIDGE_HOST
          valueFrom:
            configMapKeyRef:
              name: tectonic-config
              key: console-url
        - name: BRIDGE_PUBLIC_DIR
          value: "/opt/bridge/static"
        - name: BRIDGE_USER_AUTH
          value: "oidc"
        - name: BRIDGE_USER_AUTH_OIDC_ISSUER_URL
          valueFrom:
            configMapKeyRef:
              name: tectonic-config
              key: identity-issuer-url
        - name: BRIDGE_USER_AUTH_OIDC_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: console-client-credentials
              key: console-client-id
        - name: BRIDGE_USER_AUTH_OIDC_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: console-client-credentials
              key: console-client-secret
        - name: BRIDGE_KUBECTL_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: kubectl-client-credentials
              key: kubectl-client-id
        - name: BRIDGE_KUBECTL_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: kubectl-client-credentials
              key: kubectl-client-secret
        - name: BRIDGE_TECTONIC_VERSION
          value: "1.3.0"
        - name: BRIDGE_CA_FILE
          value: /etc/tectonic-ca-cert-secret/ca-cert
        - name: BRIDGE_TLS_CERT_FILE
          value: /etc/tectonic-console-tls-secret/tls-cert
        - name: BRIDGE_TLS_KEY_FILE
          value: /etc/tectonic-console-tls-secret/tls-key
        - name: BRIDGE_LICENSE_FILE
          value: /etc/tectonic/licenses/license
        resources:
          requests:
            cpu: 100m
            memory: 50Mi
          limits:
            cpu: 100m
            memory: 50Mi
        volumeMounts:
        - name: tectonic-console-tls-secret
          mountPath: /etc/tectonic-console-tls-secret
          readOnly: true
        - name: tectonic-ca-cert-secret
          mountPath: /etc/tectonic-ca-cert-secret
          readOnly: true
        - name: tectonic-config
          mountPath: /etc/tectonic-config
          readOnly: true
        - name: ssl-certs-host
          mountPath: /etc/ssl/certs
          readOnly: true
        - name: ca-certs-host
          mountPath: /usr/share/ca-certificates
          readOnly: true
        - name: tectonic-license
          mountPath: /etc/tectonic/licenses
          readOnly: true
      volumes:
      - name: tectonic-console-tls-secret
        secret:
          secretName: tectonic-console-tls-secret
      - name: tectonic-ca-cert-secret
        secret:
          secretName: tectonic-ca-cert-secret
      - name: tectonic-config
        configMap:
          name: tectonic-config
      - name: ssl-certs-host
        hostPath:
          path: /etc/ssl/certs
      - name: ca-certs-host
        hostPath:
          path: /usr/share/ca-certificates
      - name: tectonic-license
        secret:
          secretName: tectonic-license
      imagePullSecrets:
      - name: coreos-pull-secret

