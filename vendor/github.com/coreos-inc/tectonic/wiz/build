#!/bin/bash -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
: ${BUILD_ALL:=false}

pushd $SCRIPT_DIR

export GO15VENDOREXPERIMENT=1
LD_FLAGS="-X main.version=$(../git-version)"

mkdir -p bin/linux bin/darwin
GOOS=linux CGO_ENABLED=0 go build -o bin/linux/wiz -ldflags="$LD_FLAGS" github.com/coreos-inc/tectonic/wiz/cmd
if [ "$BUILD_ALL" = "true" ]; then
    GOOS=darwin CGO_ENABLED=0 go build -o bin/darwin/wiz -ldflags="$LD_FLAGS" github.com/coreos-inc/tectonic/wiz/cmd
fi

mkdir -p output

mkdir -p .workspace/common
cp -a ../common/* ./.workspace/common

# build frontend
pushd web
npm install
npm run build
popd

popd
